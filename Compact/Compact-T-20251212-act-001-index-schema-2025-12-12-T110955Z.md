# Compact — T-20251212-act-001-index-schema

## Scope
- Subtask: `T-20251212-act-001-index-schema`（设计索引模型与分类规则）
- Type: design, Priority: P0, Lane: now
- Dependency: `T-20251212-act-012-clarify-rules`（已完成）
- Change set: 新增 2 份设计文档；更新 `record.json` 任务状态与验收口径；按 CR 对齐 DR：固定散图定义（MediaRoot 下所有不在任何 Album 路径内的图片，任意深度）并移除“散图范围未定”开放问题；澄清散图一键整理目标目录（`MediaRoot/_unsorted/`）与软删除回收站目录（`MediaRoot/_trash/`，且默认不参与索引/视图）。

## Confirmed Facts (implemented + verified)
- 已定义索引实体与字段（见 `backend/indexing/index-schema.md`）：
  - `Folder`: 目录树节点、直接媒体计数、`has_image_descendant` 等用于叶子相册判定。
  - `Album`: 与 Folder 1:1，对应叶子图片目录；包含图片列表/数量与封面选图字段。
  - `ImageFile`: 归属 Album 或 Scattered（`album_rel_path|null`），含基础元信息与可懒解析宽高/缩略图缓存字段。
  - `VideoFile`: 扁平聚合展示所需元信息与预览图缓存字段。
  - `OtherFile`: 承载 Games/Others（`category="game"|"other"`）。
  - `OperationLog`: delete/move/archive/restore/purge 审计字段。
- 已明确 MediaRoot 沙箱路径约束（两份文档一致）：
  - 所有索引路径为 MediaRoot 内相对路径；统一 `/` 分隔；拒绝 `..`、盘符、UNC 越界。
  - 实体主键建议为规范化 `rel_path` 的 hash，保证稳定。
- 已定义分类口径（见 `product/spec/classification-rules.md`）：
  - Album 识别：目录直接含图片且不存在“含图片的子目录”（叶子图片目录）。
  - Scattered 识别：MediaRoot 下所有不在任何 Album 路径内的图片（任意层级，例如 `MediaRoot/tmp/foo.jpg` 也属于散图）。
  - Videos/Games/Others：按扩展名映射；Videos/Games/Others 均为扁平聚合，与目录层级无关。
  - 默认扩展名列表给出，并提供 `config/media-types.json` 的可扩展入口。
  - 默认忽略保留目录：`MediaRoot/_trash/`（回收站），其内容不计入扫描/索引与正常视图展示。
- 自测：`record.json` 仍为合法 JSON（`python3 json.load` 通过）。

## Interface / Behavior Changes
- 无运行时接口变更；新增设计基线文档供后续模块实现对齐。
- 后续 `backend/scanner`、`backend/indexing`、API 与前端分类展示需以本 schema 与规则为唯一口径。

## Explicit Limits / Risks / TODO
- 扩展名配置的合并策略（“完全覆盖” vs “默认追加”）仅在文档中提出建议，尚未落到代码；实现时需固定并记录。
- Games 目前仅基于可执行文件扩展名粗识别；不含“游戏目录”深度规则。
- 仅完成设计与口径落地，未产生实际扫描/索引代码；后续子任务需按此实现并验证真实目录样例。

## Code Review - T-20251212-act-001-index-schema - 2025-12-12T11:14:10Z
---review-start---
{
  "findings": [
    {
      "title": "[P2] Specify scatter cleanup target directory",
      "body": "FR-06 currently says “将散图移动至预设目录（如 ）” and the acceptance hint ends with a stray ``_unsorted`` token, so the target path for the one-click scatter cleanup is undefined. Implementers cannot tell which folder the files should be moved into, making tests and automation impossible to align. Please name the intended directory explicitly (e.g., `_unsorted`) to make the requirement executable.",
      "confidence_score": 0.34,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/read_only.md",
        "line_range": {"start": 102, "end": 104}
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "The spec leaves the scatter cleanup target directory blank, leaving a core requirement ambiguous and unimplementable until clarified.",
  "overall_confidence_score": 0.34
}
---review-end---

## Code Review - T-20251212-act-001 - 2025-12-12T11:30:37Z
---review-start---
{
  "findings": [
    {
      "title": "[P1] Soft delete target breaks MediaRoot sandbox",
      "body": "The file-management requirements say all delete/move operations must stay inside `MediaRoot`, but the soft delete step immediately moves files into “应用目录下自动创建的回收站” (application directory), which is outside the sandbox. Following this spec either violates the stated safety constraint or makes soft delete impossible without breaking the rule. Please reconcile the target (e.g., place the recycle bin under `MediaRoot` or relax the sandbox rule) so the behavior is implementable and testable.",
      "confidence_score": 0.47,
      "priority": 1,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/project_overview.md",
        "line_range": {
          "start": 108,
          "end": 117
        }
      }
    },
    {
      "title": "[P2] Album leaf rule conflicts with overview for folders containing non-image media",
      "body": "Here an album is any directory with images and no image-bearing descendants. In `project_overview.md` lines 35–38 the album definition excludes folders that still have subfolders containing any media. For a directory with photos plus a child folder holding only videos, this spec counts it as an album while the overview would not, leading to divergent album counts and classification results between docs. Please align the leaf rule (image-only vs any media in descendants) or document the precedence to avoid inconsistent implementations.",
      "confidence_score": 0.38,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/product/spec/classification-rules.md",
        "line_range": {
          "start": 40,
          "end": 48
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "Documentation introduces conflicting requirements: soft delete currently violates the MediaRoot-only safety constraint, and album-leaf criteria differ between specs, so implementers cannot produce a single correct behavior.",
  "overall_confidence_score": 0.45
}
---review-end---

## Review Follow-up (applied)
- 已修订 `read_only.md`：FR-06/D5 明确散图一键整理目标目录为 `MediaRoot/_unsorted/`，并移除验收要点末尾的 stray ``_unsorted``。
- 已修订 `project_overview.md`、`product/spec/classification-rules.md` 与 `record.json`：软删除/回收站目录固定为 `MediaRoot/_trash/`，并明确回收站内容默认不参与索引/视图，确保所有 delete/move 行为均不越界到 MediaRoot 外。
- 已修订 `product/spec/classification-rules.md`、`project_overview.md` 与 `record.json`：相册叶子规则统一为“叶子图片目录”（仅以图片后代为准，子目录仅含视频/其他媒体不影响 Album 判定），避免文档口径不一致。

## Code Review - T-20251212-act-001-index-schema - 2025-12-12T12:05:55Z
---review-start---
{
  "findings": [
    {
      "title": "[P1] Album rule conflicts with leaf-only definition",
      "body": "FR-03 still says any MediaRoot subdirectory containing images is an album, without excluding folders that have image-bearing descendants. This contradicts the unified leaf-only rule documented elsewhere (albums are only image folders with no image subfolders). For a folder that has images plus a child folder with images, this spec would count both as albums, while the new rule would exclude the parent, leading to divergent album counts and UI lists depending on which rule engineers follow. Please align FR-03 with the leaf-only album definition to avoid inconsistent implementations.",
      "confidence_score": 0.63,
      "priority": 1,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/read_only.md",
        "line_range": {
          "start": 93,
          "end": 94
        }
      }
    },
    {
      "title": "[P1] Scattered definition outdated to root-only images",
      "body": "The DR still defines scattered images as files directly under MediaRoot or other mixed directories, implying only top-level or ad hoc folders are included. The updated classification rule and decisions state scattered should include every image not under any album path (any depth). With this mismatch, images in non-album nested folders (e.g., MediaRoot/tmp/foo.jpg) would be excluded from scattered per this doc but included per the product spec, leaving engineers and tests to disagree on expected lists. Please update the scattered definition here to match the “all images outside any album path” rule.",
      "confidence_score": 0.58,
      "priority": 1,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/Webui-dr/Webui-2025-12-12-dr.md",
        "line_range": {
          "start": 19,
          "end": 20
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "Key documentation still contradicts the newly established classification rules for albums and scattered images, so implementers cannot produce a single consistent behavior without further fixes.",
  "overall_confidence_score": 0.62
}
---review-end---

## Code Review - T-20251212-act-001-index-schema - 2025-12-12T12:28:17Z
---review-start---
{
  "findings": [
    {
      "title": "[P1] Album rule still counts parent folders with image descendants",
      "body": "This DR section still defines every image-bearing folder as an album and says child folders with images also become independent albums, which conflicts with the leaf-only rule now in `read_only.md`/`classification-rules.md` (only image folders with no image descendants are albums). For a folder containing photos plus a child folder with photos, following this doc would create two albums while the updated spec would exclude the parent, leading to divergent album counts and UI listings depending on which rule engineers implement.",
      "confidence_score": 0.57,
      "priority": 1,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/Webui-dr/Webui-2025-12-12-dr.md",
        "line_range": {
          "start": 17,
          "end": 21
        }
      }
    },
    {
      "title": "[P2] Scatter cleanup requirement downgraded and target path unclear",
      "body": "Here scatter cleanup is marked optional and only examples `_unsorted` without stating it must be `MediaRoot/_unsorted/`, while `read_only.md` and the task record require a mandatory one-click move into `MediaRoot/_unsorted/` with logging. This mismatch leaves implementers unsure whether the feature is required and which directory to move files into, so the behavior and tests for scatter cleanup will diverge across docs.",
      "confidence_score": 0.42,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/project_overview.md",
        "line_range": {
          "start": 48,
          "end": 56
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "Documentation still contains conflicting requirements: the DR contradicts the leaf-only album rule, and the overview downplays and underspecifies the mandatory scatter cleanup target. These inconsistencies prevent a single correct implementation.",
  "overall_confidence_score": 0.55
}
---review-end---

## Review Follow-up (applied)
- 已修订 `read_only.md`：FR-06 明确散图一键整理目标目录为 `MediaRoot/_unsorted/`，避免需求不可执行。
- 已对齐软删除回收站策略：回收站目录固定为 `MediaRoot/_trash/` 且默认不参与索引/视图，保证 MediaRoot 沙箱不越界。
- 已修订 `project_overview.md`：散图定义与一键整理目标目录对齐（`MediaRoot/_unsorted/`），不再降级为可选能力。
- 已核对 `read_only.md`：FR-03 与“叶子图片目录”相册规则一致，避免父子目录同时计为相册导致实现与 UI 列表不一致。
- 已修订 `Webui-dr/Webui-2025-12-12-dr.md`：相册定义对齐为“叶子图片目录”（父目录仅作容器，不重复计为相册），避免父子目录同时计为相册导致实现与 UI 列表不一致。
- 已修订 `Webui-dr/Webui-2025-12-12-dr.md`：散图定义更新为“MediaRoot 下所有不在任何 Album 路径内的图片（任意层级）”，涵盖 `MediaRoot/tmp/foo.jpg` 等非相册嵌套目录。
- 已修订 `record.json`：补充散图整理目标目录，并对齐 `answers_for_human` 的相册叶子规则与散图口径（散图任意层级且不在任何 Album 路径内）。

## Code Review - T-20251212-act-001-index-schema - 2025-12-12T13:15:55Z
---review-start---
{
  "findings": [
    {
      "title": "[P1] Soft delete marked optional despite MVP default decision",
      "body": "FR-09 still labels soft delete/recycle bin as optional, but `project_overview.md` and `record.json` now state MVP must always soft-delete into `MediaRoot/_trash/` with 10‑day retention. Engineers implementing from this doc would omit mandatory recycle-bin behavior or place it inconsistently, leading to divergent delete flows and indexes that either include or exclude `_trash` content. Please align this requirement with the finalized default recycle-bin policy.",
      "confidence_score": 0.49,
      "priority": 1,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/read_only.md",
        "line_range": {
          "start": 111,
          "end": 112
        }
      }
    },
    {
      "title": "[P2] Scattered scope left undecided while other specs fix the rule",
      "body": "This DR still treats the scattered-image scope as an open question, implying the rule is undefined. However `product/spec/classification-rules.md` and `project_overview.md` now fix scattered as all images outside any album path at any depth. Keeping this unresolved here will send mixed signals on whether engineers should implement or delay scattered listing, causing tests and downstream tasks to diverge. Update the DR wording to reflect the finalized scattered definition.",
      "confidence_score": 0.42,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/Webui/read_only.md",
        "line_range": {
          "start": 179,
          "end": 180
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "Documentation still conflicts on core behaviors: soft delete remains optional in the DR despite being mandated elsewhere, and the scattered-image rule is left unresolved despite having been finalized. These inconsistencies prevent a single correct implementation.",
  "overall_confidence_score": 0.48
}
---review-end---

## Review Follow-up (applied)
- 已修订 `read_only.md`：FR-09 不再标为可选，软删除/回收站在 MVP 默认开启（删除即移动至 `MediaRoot/_trash/`，自动创建；默认不参与索引/视图；保留 10 天后自动清理；支持恢复/彻底清空）。
- 已修订 `read_only.md`：散图口径不再作为开放问题，验收要点与定义对齐为“任意层级且不在任何 Album 路径内”，与 `product/spec/classification-rules.md`、`project_overview.md` 一致。
- 已修订 `record.json`：`T-20251212-act-012-clarify-rules` 的验收口径中移除“是否启用”措辞，改为“软删除/回收站在 MVP 默认开启”。
- 自测：`record.json` 仍为合法 JSON（`python3 json.load` 通过）。
