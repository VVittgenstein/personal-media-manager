# Compact — T-20251212-act-010-bat-launcher

## Scope
- Subtask: `T-20251212-act-010-bat-launcher`（实现 Windows .bat 一键启动并自动打开浏览器）
- Type: infra, Priority: P1, Lane: now
- Dependency: `T-20251212-act-010-backend-config`（已完成；脚本消费其 stdout URL 输出与端口冲突 auto 行为）
- Acceptance (record.json):
  - 双击 .bat 可启动后端服务并自动打开默认浏览器
  - 读取 MediaRoot/端口配置并传递给服务
  - 启动失败或端口占用时提示清晰可理解

## Change Set（代码改动）
- 新增 `start.bat`：仓库根入口，转调 `infra/windows/start.bat` 并透传参数
- 新增 `infra/windows/start.bat`：调用 PowerShell 脚本执行启动逻辑；失败时暂停
- 新增 `infra/windows/start.ps1`：
  - 读取并校验 `config/backend.json`（含 JSON 解析、MediaRoot/host/port）
  - 启动 `py -3 -m backend.api`（或 `python -m backend.api`），固定 `--port-conflict auto`
  - 解析后端输出的首个 `http(s)://...` 并用默认浏览器打开
- 更新 `README.md`：补充 Windows one-click 用法
- Meta：`record.json` 将该 subtask 标记为 done，并补充 artifacts/updated_at

## Confirmed Facts（代码 + 自测覆盖）
- 本次输入未提供可复现的自测结果；Windows launcher 行为未在自动化单测中覆盖。

## Implemented Behavior（代码已实现）
- MediaRoot 来源优先级：`start.bat <MediaRoot>` 参数 > `config/backend.json:media_root`
- 启动前校验：
  - 缺少 `config/backend.json` / JSON 解析失败 / MediaRoot 为空或目录不存在 / port 非整数 / 找不到 `py|python` → 输出 `[ERROR] ...` 并退出（不同 exit code）
- 端口占用：
  - 始终用 `--port-conflict auto` 启动；若后端自动换端口，脚本通过解析 stdout 的实际 URL 打开浏览器
- 浏览器打开：
  - 仅在首次捕获到 URL 时 `Start-Process <url>` 一次；随后持续转发后端输出直到退出

## Explicit Limits / Risks / TODO（显式边界）
- 依赖 Windows PowerShell 可用（调用 `powershell -ExecutionPolicy Bypass`）；受限环境可能被策略拦截
- 依赖系统已安装 Python 3 并可通过 `py` 或 `python` 调用；未处理依赖安装（如 Pillow/FFmpeg）
- URL 识别基于正则 `https?://\S+`：若后端输出格式改变或出现其它 URL 行，可能误开/漏开
- 当前仅支持把 MediaRoot 作为“第一个参数”传入；未做更复杂参数解析（如 `--media-root` 风格）

## Interface Impact（可能影响其他模块）
- 与后端启动契约绑定：依赖 `python -m backend.api` 在 stdout 输出可访问 URL（用于浏览器打开），并支持 `--config/--media-root/--host/--port/--port-conflict`
- 新增交付入口：用户面向 `start.bat`（根目录），实际实现位于 `infra/windows/*`

## Self-test（建议手动验证）
- Windows：编辑 `config/backend.json` 设置 `media_root` 或运行 `start.bat D:\Media`，确认：
  - 终端打印 URL 且默认浏览器自动打开
  - 将 `port` 设为已占用端口时自动换端口并打开新 URL
  - 触发缺少 Python / MediaRoot 为空 / 配置 JSON 错误时错误提示可理解并暂停

