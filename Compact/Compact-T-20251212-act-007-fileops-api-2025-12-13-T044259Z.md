# Compact — T-20251212-act-007-fileops-api

## Scope
- Subtask: `T-20251212-act-007-fileops-api`（实现删除/移动后端 API：沙箱 + 二次确认 + 操作日志）
- Type: build, Priority: P0, Lane: now
- Dependency: `T-20251212-act-001-classify-api`（已完成）
- Acceptance (record.json):
  - 提供 delete/move API（MediaRoot 内相对路径入参）
  - 后端严格校验路径不越界
  - 每次操作写入 OperationLog（时间、动作、源/目标、结果）
  - API 返回足够信息供前端二次确认展示
- Change set (code):
  - 新增 `backend/security/fileops.py`：delete/move 两段式确认 + 执行
  - 新增 `backend/security/operation_log.py`：JSONL append 的 OperationLogStore
  - 更新 `backend/api/server.py`：新增 `POST /api/delete`、`POST /api/move`，CORS 允许 POST，新增 `--operation-log`
  - 更新 `backend/scanner/sandbox.py`：新增 `to_abs_path_allow_missing`（用于 move 目的路径前缀校验）
  - 新增/更新自测：`backend/api/tests/test_server.py`、`backend/scanner/tests/test_inventory.py`
- Self-test (reported): `python3 -m unittest -q` → OK（10 tests）

## Confirmed Facts（代码 + 自测覆盖）
- 新增 fileops HTTP 接口（`backend/api/server.py`）：
  - `POST /api/move`：
    - preview：返回 `confirm_required=true`、`preview{src_rel_path,dst_rel_path,create_parents,is_dir,size_bytes,mtime_ms}` 与 `confirm_token`（测试覆盖）
    - confirm：携带 `confirm=true` + `confirm_token` 后执行移动（测试覆盖 `create_parents=true` 并实际落盘）
  - `POST /api/delete`：
    - preview：返回 `confirm_required=true`、`preview{src_rel_path,is_dir,size_bytes,mtime_ms}` 与 `confirm_token`（测试覆盖）
    - confirm：携带 `confirm=true` + `confirm_token` 后执行删除（测试覆盖）
- 操作日志落盘（`backend/security/operation_log.py`）：
  - confirmed delete/move 会追加写入 JSONL；自测读取 log 文件，验证至少写入 2 条且末条 `op=="delete"`、`success==true`（测试覆盖）
- 沙箱能力对齐（来自既有 scanner/sandbox 基元 + 本次补齐）：
  - `normalize_rel_path` 规则（拒绝 `..`、盘符、UNC、绝对路径等）与 symlink traversal 拒绝已有单测覆盖；本次新增 `to_abs_path_allow_missing` 并补测“允许目标路径不存在但拒绝已存在 symlink 前缀”（测试覆盖）

## Interface / Behavior Changes（影响下游对接）
- 新增 CORS 允许 POST：`Access-Control-Allow-Methods` 从 `GET, OPTIONS` → `GET, POST, OPTIONS`（`backend/api/server.py`）
- 新增 API 契约（供后续 `T-20251212-act-007-fileops-ui` 对接）：
  - `POST /api/delete` body：`{ "path": <rel>, "confirm"?: bool, "confirm_token"?: string }`
  - `POST /api/move` body：`{ "src": <rel>, "dst": <rel>, "create_parents"?: bool, "confirm"?: bool, "confirm_token"?: string }`
  - 统一错误形状：`{ "error": { "code": string, "message": string } }`（HTTP status 随错误变化）
- 新增 server 启动参数：
  - `python3 -m backend.api --operation-log <path>`（默认 `backend/data/operation-log.jsonl`）

## Key Implementation Notes（事实快照）
- 二次确认令牌：`confirm_token` 为基于 HMAC-SHA256 的摘要（canonical JSON：op + src/dst + 基础 stat + create_parents），用于“preview→confirm”一致性校验（`backend/security/fileops.py`）
- 删除为硬删除：文件 `unlink()`，目录 `shutil.rmtree()`；软删除/回收站不在本 subtask 范围（对应后续 `T-20251212-act-007-soft-delete`）
- fileops 不会自动刷新 `_IndexCache`；调用方需通过现有 GET 接口 `?refresh=1` 触发重建以避免 stale 列表（`backend/api/server.py`）

## Explicit Limits / Risks / TODO（显式边界）
- token 生命周期：confirm secret 为进程内随机值（server 重启后 token 失效）；未实现 token 过期时间/nonce（实现未覆盖测试）
- 错误码映射细节（实现存在潜在问题，未覆盖测试）：
  - `MediaRootSandbox.to_abs_path()` 要求路径段可 stat；不存在路径可能被归类为 `SANDBOX_VIOLATION` 而非 404
  - confirmed `move()` 的执行阶段对 `FileOpsError` 统一 wrap 为 `MOVE_FAILED`(500)，可能掩盖期望的 4xx（如并发导致的 `DST_EXISTS`(409)）
- 版本控制噪声：仓库当前跟踪 `__pycache__/*.pyc`，运行自测会更新二进制 diff；PR/提交前应避免混入（非功能变更）

