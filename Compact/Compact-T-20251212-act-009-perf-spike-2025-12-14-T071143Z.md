# Compact — T-20251212-act-009-perf-spike

## 1) Scope（来自 record.json）
- Subtask: `T-20251212-act-009-perf-spike`（执行缩略图/懒加载/大库性能 Spike 并出报告）
- Type: research, Priority: P1, Lane: next
- Acceptance:
  - 构建或获取万级媒体测试集并记录硬件基线
  - 测量索引、缩略图生成、首屏与滚动性能
  - 输出报告含耗时/资源占用/瓶颈与参数建议

## 2) 交付物（新增）
- 可复现数据集生成脚本：`perf/test/generate_media_root.py`
- Benchmark 脚本（输出 JSON）：`perf/test/run_perf_spike.py`
- 使用说明：`perf/test/README.md`
- Spike 报告：`doc/perf/perf-spike.md`

## 3) 关键结论（摘要）
- Index（10k 图 + 500 video + 500 other，本机环境）：
  - `build_media_index` p50 `~45.5ms`，p95 `~55.1ms`，RSS `27.5MB → 36.2MB`
- Thumbnails（sample_images=2000，本机环境）：
  - `thumb_size=320,q=82,workers=2`：direct_cold `~148 items/s`；batch_cold `~161 items/s`
  - `thumb_size=320,q=82,workers=4`：direct_cold `~227 items/s`；batch_cold `~271 items/s`
  - `thumb_size=240` 更快但观感下降；`thumb_size=480` 成本明显上升
- 前端结论（基于实现形态）：
  - 已具备 `IntersectionObserver + loading=lazy` 的请求级懒加载，但长列表仍会一次性创建大量 DOM；大于几千条时 DOM/布局会成为滚动瓶颈，建议后续引入“增量渲染 / 虚拟列表”。

## 4) 自测
- `python3 -m unittest discover -v` → OK（28 tests）

## 5) 显式限制
- 本次环境未提供 `ffmpeg/ffprobe`，因此 video mosaic 的压测在报告中标记为跳过；在 Windows 目标机需按文档自行安装并复测。
- 默认生成的数据集为“合成渐变图”，可复现但不等同于真实 4K/噪声纹理素材；建议在目标机器补充真实样本或使用脚本参数生成更大尺寸/更复杂图像进行复测。

## Code Review - T-20251212-act-009-perf-spike - 2025-12-14T07:30:50Z

---review-start---
{
  "findings": [
    {
      "title": "[P2] Album/video benches skip when only thumbs disabled",
      "body": "The `--sample-images` flag is documented as controlling thumbnail sampling, but the current guard in `main` also skips album cover and video mosaic benchmarks (`if cfg.sample_images and cfg.sample_images > 0`). Running with `--sample-images 0` (to omit expensive thumb generation) silently drops cover and mosaic metrics, so the JSON output lacks those sections even though they are unrelated to image sampling. Consider gating only the thumbnail bench on this flag so album/video results still run when thumbnails are intentionally skipped.",
      "confidence_score": 0.43,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/personal-pron-media-manager/perf/test/run_perf_spike.py",
        "line_range": {
          "start": 394,
          "end": 397
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "The new perf spike script suppresses album cover and video mosaic benchmarks whenever thumbnail sampling is disabled, contradicting the flag’s intent and producing incomplete results.",
  "overall_confidence_score": 0.43
}
---review-end---
