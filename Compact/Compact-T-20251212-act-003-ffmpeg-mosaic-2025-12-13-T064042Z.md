# Compact — T-20251212-act-003-ffmpeg-mosaic

## 1) Scope 对齐（来自 record.json）
- Subtask: `T-20251212-act-003-ffmpeg-mosaic`（FFmpeg 抽帧生成视频 2×2 预览缩略图并缓存）
- Priority/Lane: `P0` / `now`
- Depends on: `T-20251212-act-001-classify-api`, `T-20251212-act-011-license-review`
- Acceptance:
  - 对视频抽取 4 帧并生成 2×2 拼图缩略图
  - 缩略图缓存命中复用；视频更新时重建
  - FFmpeg 不可用时：缓存命中仍可返回；缓存未命中则返回明确错误与安装/配置指引

## 2) Interface / 行为变更（影响下游对接）
- 新增 HTTP：
  - `GET /api/video-mosaic?path=<VIDEO_REL>`：返回 `image/jpeg`（带 `ETag`，支持 `If-None-Match` → `304`）
- 缓存目录：
  - 复用 `--thumb-cache-dir`（默认 OS cache dir），在其下新增 `video-mosaics/` 子目录

## 3) 已确认事实（代码 + 自测覆盖）
- 自测命令：`python3 -m unittest -q` → `OK`
- `/api/video-mosaic`：
  - 缓存命中时无需 FFmpeg（`backend/api/tests/test_server.py` 覆盖）
  - 缓存未命中且 FFmpeg 不可用时返回 `503` 且错误码为 `FFMPEG_NOT_AVAILABLE`（message 含安装/配置 PATH 指引）
  - 生成成功时带 `ETag`，支持 `If-None-Match` → `304`（`backend/api/tests/test_server.py` 覆盖）
  - 视频文件内容变化后 `ETag` 会变化并触发重建（`backend/api/tests/test_server.py` 覆盖）

## 4) 实现事实快照（实现要点）
- 选帧策略：
  - 优先尝试 `ffprobe` 获取 duration（可选）；选取 `5% / 25% / 50% / 75%` 四个时间点抽帧
  - 单帧抽取失败时回退到 `t=0`（保证尽量产出 4 张 tile）
- 缓存与失效：
  - `ETag` key = mosaic spec +（`mtime+size` 或 `sha1`，由 `--thumb-key` 决定）
  - 缓存文件路径：`<cache>/video-mosaics/<aa>/<bb>/<etag>.jpg`
- 安全边界：
  - `path` 必须为 MediaRoot 内相对路径；通过 `normalize_rel_path` + `MediaRootSandbox` 拒绝越界与 symlink/junction 逃逸
- 渲染样式：
  - 每个 tile 使用“放大裁切模糊背景 + 前景等比完整可见”策略（避免黑边），拼成 2×2 JPEG

## 5) 显式限制 / 风险 / TODO（未在本 Subtask 内解决）
- 运行时依赖：生成需要外部 `ffmpeg`（及可选 `ffprobe`）；缓存命中时不依赖 `ffmpeg`；本项目不随包分发，需用户自装并配置 PATH
- Pillow：用于拼图渲染；未安装时返回 `503 PILLOW_NOT_INSTALLED`
- 缓存治理：未实现 cache 清理/TTL（视频更新会产生陈旧文件残留）

## Code Review - T-20251212-act-003 - 2025-12-13T06:54:05Z

---review-start---
{
  "findings": [
    {
      "title": "[P2] Serve cached mosaics without requiring FFmpeg",
      "body": "The new `/api/video-mosaic` path fails with `FFMPEG_NOT_AVAILABLE` whenever FFmpeg is absent, even if a mosaic for that file is already cached. `ensure_mosaic` resolves FFmpeg before checking whether the cache file exists, so users who generated mosaics earlier cannot serve them after FFmpeg is removed or temporarily unavailable, despite the cache being valid. Move the FFmpeg requirement after the cache hit check so cached results can still be returned.",
      "confidence_score": 0.36,
      "priority": 2,
      "code_location": {
        "absolute_file_path": "/mnt/z/Project/personal-pron-media-manager/backend/thumbnails/video_mosaics.py",
        "line_range": {
          "start": 215,
          "end": 235
        }
      }
    }
  ],
  "overall_correctness": "patch is incorrect",
  "overall_explanation": "The video mosaic endpoint now hard-fails when FFmpeg is missing even if a cached mosaic already exists, preventing reuse of valid cache entries. This functional regression means the change is not fully correct.",
  "overall_confidence_score": 0.36
}
---review-end---

## Review Follow-up (applied)
- 已修复 `backend/thumbnails/video_mosaics.py`：`ensure_mosaic()` 先检查 cache hit，再要求 FFmpeg；命中时可在无 FFmpeg 环境下返回。
- 已新增回归测试：`backend/api/tests/test_server.py` 增加 `test_video_mosaic_endpoint_serves_cached_without_ffmpeg`，覆盖 cache hit 返回 200 与 `If-None-Match` → 304。
- 已更新 `record.json`：补充验收口径“FFmpeg 不可用但缓存命中仍可返回”，并更新 `T-20251212-act-003-ffmpeg-mosaic` 的 `updated_at`。
