# Compact — T-20251212-act-002-image-thumbs

## Scope
- Subtask: `T-20251212-act-002-image-thumbs`（实现图片缩略图生成与缓存）
- Type: build, Priority: P0, Lane: now
- Dependency: `T-20251212-act-001-classify-api`（已完成）
- Acceptance (record.json):
  - 为图片生成固定尺寸缩略图（尺寸/质量可配置）
  - 缩略图存储在缓存目录并按内容/mtime 命中复用
  - 提供稳定 URL 供前端获取缩略图
  - 批量生成支持后台队列或限速避免阻塞

## Change Set（代码改动）
- 新增 `backend/thumbnails/image_thumbs.py`：ThumbnailService（缓存键、队列、限速、Pillow 渲染）
- 新增 `backend/thumbnails/__init__.py`
- 更新 `backend/api/server.py`：
  - `GET /api/thumb?path=<REL>`：生成/读取缩略图并返回 `image/jpeg`
  - `POST /api/thumbs/warm`：批量入队后台生成
  - 新增 CLI 参数：`--thumb-cache-dir/--thumb-size/--thumb-quality/--thumb-workers/--thumb-key`
- 新增 `backend/requirements.txt`：引入 Pillow 依赖声明
- 更新 `backend/api/tests/test_server.py`：增加 /api/thumb 与 /api/thumbs/warm 自测（Pillow 未安装时验证 503 降级）
- 文档同步：`README.md`、`NOTICE`、`doc/licenses/dependency-license-list.md`

## Confirmed Facts（行为口径）
- 缩略图格式与尺寸：
  - 输出统一为 `JPEG`（`image/jpeg`），尺寸为正方形 `thumb_size × thumb_size`（默认 320）
  - 生成策略：前景等比缩放完整可见；背景使用同图“放大裁切 + 高斯模糊 + 轻微变暗”填充，避免黑边
  - 质量：`thumb_quality`（默认 82，范围 1~95）
- 缓存与复用：
  - 缓存目录默认使用 OS cache 目录（可通过 `--thumb-cache-dir` 覆盖）
  - 缓存键模式（`--thumb-key`）：
    - `mtime`（默认）：`rel_path + mtime_ns + size_bytes + thumb_spec` → sha1 作为 ETag/文件名
    - `sha1`：`sha1(file_content) + thumb_spec` → sha1 作为 ETag/文件名（可跨路径复用同内容）
- HTTP 接口：
  - `GET /api/thumb?path=<REL>`：
    - 命中缓存直接返回；未命中会生成后返回
    - 返回 `ETag`，支持 `If-None-Match` 命中后返回 `304`
    - `Cache-Control: public, max-age=0, must-revalidate`（保证 URL 不含版本号时仍可稳定刷新）
  - `POST /api/thumbs/warm`：`{ "paths": [<REL>...] }` → `202` + `{ok, accepted, skipped_cached, rejected}`
- 队列/限速：
  - ThumbnailService 内置后台 worker 线程 + 有界队列（默认 2 workers，queue_size=2048）
  - 生成并发由 semaphore 限制为 `thumb_workers`，避免大量并发请求把 CPU 拉满
- 降级：
  - 未安装 Pillow 时：`GET /api/thumb` 返回 `503` + `PILLOW_NOT_INSTALLED` 错误码；warm 入队仍返回 202（后台会记录 debug 日志并跳过）

## Self-test (reported)
- `python3 -m unittest -q` → OK（11 tests）

## Explicit Limits / TODO（显式边界）
- 未实现缓存清理策略（旧 key 的缩略图会残留；后续可加 TTL 或按目录扫描清理）
- `heic/avif/svg` 等扩展名虽然被归类为 image，但 Pillow 在无插件/编译支持时可能无法解码（将返回 `THUMBNAIL_FAILED`）
- 相册 2×2 四宫格封面（`T-20251212-act-002-album-cover-mosaic`）未在本 subtask 范围内
