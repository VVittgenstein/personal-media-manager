# Compact — T-20251212-act-007-soft-delete

## Scope
- Task: `T-20251212-act-007-soft-delete`（实现软删除/回收站：MVP 默认开启）
- Type: build, Priority: P0, Lane: now
- Dependencies: `T-20251212-act-007-fileops-api`、`T-20251212-act-012-clarify-rules`（已完成）
- Acceptance (record.json):
  - 删除默认软删除：移动到 `MediaRoot/_trash/`（自动创建；默认不参与索引/视图）
  - 回收站保留 10 天后自动清理
  - 提供恢复/清空回收站能力（API）
  - 软删除/恢复/清空均记录操作日志

## Changes（代码落点）
- `backend/security/fileops.py`
  - `POST /api/delete` 默认变更为软删除（archive）：将目标移动到 `MediaRoot/_trash/<confirm_token>/<basename>`
  - 新增回收站 API：`trash_restore()`、`trash_empty()`
  - 新增回收站自动清理：启动时执行一次 + 调用节流（默认 1h）+ 10 天保留策略
  - 清空/清理使用 symlink/reparse 安全删除（避免跟随链接越界）
  - 操作日志：archive/restore/purge
- `backend/api/server.py`
  - 新增 `POST /api/trash/restore`、`POST /api/trash/empty` 路由
- `frontend/spa/app.js`
  - Delete 弹窗文案更新为“移动到回收站（10 天可恢复）”，并展示 Trash 目标路径
- `backend/api/tests/test_server.py`
  - 更新 delete 测试为软删除语义（断言落盘到 `_trash/` 且 op=archive）
  - 新增 restore/empty/cleanup 自测用例

## Confirmed Facts（代码 + 自测覆盖）
- 删除（软删除）：
  - `POST /api/delete` preview 返回 `preview.dst_rel_path`（回收站目标）与 `confirm_token`
  - confirmed 删除会把文件从原路径移入 `MediaRoot/_trash/...`，并写入 `OperationLog(op="archive")`
- 恢复：
  - `POST /api/trash/restore` preview→confirm 可将 `_trash/...` 中的条目恢复回原始路径，写入 `OperationLog(op="restore")`
- 清空回收站：
  - `POST /api/trash/empty` preview→confirm 删除 `_trash` 下所有条目，写入 `OperationLog(op="purge")`
- 自动清理：
  - 服务启动初始化 `FileOpsService` 时会清理回收站中超过 10 天的条目，并写入 `OperationLog(op="purge")`
- `_trash` 默认不参与索引/视图展示：
  - 既有扫描/索引默认跳过 `_trash`，不受本次变更影响（已有单测覆盖）

## Interface / Behavior Changes（影响下游对接）
- `POST /api/delete`（保持两段式确认形状）
  - preview 增加：`preview.dst_rel_path`，并在响应顶层增加 `delete_mode: "archive"`
  - confirm 成功响应增加：`dst_rel_path`（回收站 payload 路径）
- 新增 API：
  - `POST /api/trash/restore` body：`{ "path": <trash_rel>, "confirm"?: bool, "confirm_token"?: string }`
  - `POST /api/trash/empty` body：`{ "confirm"?: bool, "confirm_token"?: string }`

## Self-test（本次容器内执行）
- `python3 -m unittest -q` → OK（30 tests）

