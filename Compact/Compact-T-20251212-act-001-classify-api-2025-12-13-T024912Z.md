# Compact — T-20251212-act-001-classify-api

## 1) 范围对齐

- Subtask：T-20251212-act-001-classify-api（实现媒体分类索引与查询 API）
- 依赖：T-20251212-act-001-scan-inventory、T-20251212-act-001-index-schema、T-20251212-act-012-clarify-rules
- 验收草案（record.json）：叶子相册/散图/视频/游戏/其他按规则归类；默认忽略 `MediaRoot/_trash/`；提供 `/api/albums`、`/api/scattered`、`/api/videos`、`/api/others`；所有返回路径为 MediaRoot 内相对路径
- 自测：`python3 -m unittest discover -v`（7 tests, OK）

## 2) 已确认事实（代码 + 自测覆盖）

- 分类索引：`backend/indexing/media_index.py`
  - 叶子相册判定 + 计数：测试样例中输出相册 `["temp","travel/beach","travel/food"]`，并分别返回图片计数 `1/2/1`（`backend/indexing/tests/test_media_index.py`）。
  - 散图判定：样例中散图为 `{"loose.jpg","travel/preview.png"}`（不在任何 Album 路径内）（同上测试）。
  - 视频扁平列表：样例中视频为 `{"travel/beach/v.mp4","video.mp4"}`（同上测试）。
  - Games/Others：样例中 `game.exe` 归入 games；`doc.txt` 与 `temp/raw/note.txt` 归入 others（同上测试）。
  - 默认忽略回收站：样例中 `_trash/*` 不出现在以上任何集合（同上测试）；扫描层面默认跳过 `_trash`（`backend/scanner/tests/test_inventory.py`）。
- 查询 API：`backend/api/server.py`
  - `GET /api/albums|/api/scattered|/api/videos|/api/others` 返回 200 且 JSON 具备预期顶层字段（`backend/api/tests/test_server.py`）。

## 3) 接口与行为变更（供下游模块对接）

- 服务入口：`python3 -m backend.api --media-root <ABS_PATH>`（`backend/api/__main__.py`）
- `GET /api/albums[?refresh=1]` → `{media_root, scanned_at_ms, items:[{rel_path,name,title,image_count,mtime_ms}]}`
- `GET /api/scattered[?refresh=1]` → `{media_root, scanned_at_ms, items:[{rel_path,folder_rel_path,ext,size_bytes,mtime_ms}]}`
- `GET /api/videos[?refresh=1]` → `{media_root, scanned_at_ms, items:[{rel_path,folder_rel_path,ext,size_bytes,mtime_ms}]}`
- `GET /api/others[?refresh=1]` → `{media_root, scanned_at_ms, games:[{...,category:"game"}], others:[{...,category:"other"}]}`

## 4) 关键实现要点（事实快照）

- 索引构建基于扫描结果：`build_media_index()` 内部调用 `scan_inventory(media_root, skip_trash=...)`（`backend/indexing/media_index.py`）。
- 扩展名映射：内置默认 images/videos/games 扩展名集合；若存在 `config/media-types.json`（或显式 `--media-types-config`）则按配置覆盖（`backend/indexing/media_types.py`）。
- 输出稳定性：`albums/scattered/videos/games/others` 以 `rel_path` 字典序排序后返回（`backend/indexing/media_index.py`）。
- API 运行时缓存：进程内 `_IndexCache` 缓存上次构建结果；`refresh=1` 时强制重建（`backend/api/server.py`）。

## 5) 显式限制 / 风险 / TODO（当前实现边界）

- 仅实现“列表/索引”与只读查询：未实现相册详情（相册内图片列表）、分页/筛选/搜索、索引持久化或增量更新。
- API 框架为 `http.server`（非 Flask/FastAPI）；返回字段为当前实现约定，后续 UI/其他 API 需按本 schema 对接或再抽象稳定契约。
- `config/media-types.json` 的“覆盖 vs 追加”策略当前为覆盖（存在即替换对应集合）；若产品期望“在默认基础上追加”，需显式调整。
- 本地服务默认 `Access-Control-Allow-Origin: *` 且无鉴权；假设仅本机 localhost 使用（`--host` 默认为 127.0.0.1）。
- 工作区可能产生未提交运行产物：`backend/indexing/__pycache__/`（提交前建议忽略/清理，避免混入 PR）。

