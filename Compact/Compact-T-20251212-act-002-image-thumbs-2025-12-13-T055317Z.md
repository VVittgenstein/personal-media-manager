# Compact — T-20251212-act-002-image-thumbs

## 1) Scope 对齐（来自 record.json）
- Subtask: `T-20251212-act-002-image-thumbs`（实现图片缩略图生成与缓存）
- Priority/Lane: `P0` / `now`
- Depends on: `T-20251212-act-001-classify-api`
- Acceptance:
  - 固定尺寸缩略图（尺寸/质量可配置）
  - 缓存目录复用（按内容/mtime 命中）
  - 稳定 URL 获取缩略图
  - 批量生成支持后台队列或限速

## 2) Interface / 行为变更（影响下游对接）
- 新增 HTTP：
  - `GET /api/thumb?path=<REL>`：返回 `image/jpeg`（带 `ETag`，支持 `If-None-Match` → `304`）
  - `POST /api/thumbs/warm`：body `{"paths":[<REL>...]}` → `202` + `{ok, accepted, skipped_cached, rejected}`
- Server CLI 新增参数（`python3 -m backend.api ...`）：
  - `--thumb-cache-dir`、`--thumb-size`、`--thumb-quality`、`--thumb-workers`、`--thumb-key={mtime|sha1}`
- 依赖声明变化：
  - 新增 `backend/requirements.txt`（Pillow 用于图片缩略图）
  - `NOTICE`/`doc/licenses/dependency-license-list.md` 同步将 Pillow 归为运行时依赖（不随仓库分发）

## 3) 已确认事实（代码 + 自测覆盖）
- 自测命令：`python3 -m unittest -q` → `OK`
- `/api/thumb`：
  - 当环境未安装 Pillow 时，返回 `503` 且错误码为 `PILLOW_NOT_INSTALLED`（`backend/api/tests/test_server.py` 覆盖）
- `/api/thumbs/warm`：
  - 返回 `202`，且响应包含 `ok/accepted` 字段（`backend/api/tests/test_server.py` 覆盖）

## 4) 实现事实快照（代码实现；部分依赖 Pillow 才能在运行时生效）
- 缩略图生成与样式：
  - 输出统一为 JPEG；前景等比缩放完整可见；背景用同图“放大裁切 + 高斯模糊 + 轻微变暗”填充（避免黑边）
- 安全边界：
  - `path` 必须为 MediaRoot 内相对路径；经 `normalize_rel_path` 校验，并通过 `MediaRootSandbox.to_abs_path` 拒绝越界/重解析点（symlink/junction）
  - 非图片扩展名直接返回 `415 UNSUPPORTED_MEDIA_TYPE`
- 缓存与命中：
  - 缓存文件名使用 `ETag`（sha1）并按前缀分两级目录存放：`<cache>/<aa>/<bb>/<etag>.jpg`
  - cache key：
    - `mtime`（默认）：thumb_spec + `rel_path + st_mtime_ns + st_size`
    - `sha1`：thumb_spec + `sha1(file_content)`（读取全文件）
- 批量/限速：
  - in-process 有界队列（默认 `queue_size=2048`）+ worker 线程（默认 `2`）后台生成
  - 生成并发由 semaphore 限制；获取不到 semaphore（30s）时 `429 THUMB_RATE_LIMITED`
- HTTP 缓存语义：
  - `Cache-Control: public, max-age=0, must-revalidate`（不使用 URL 版本号时依赖 ETag 做再验证）

## 5) 显式限制 / 风险 / TODO（未在本 Subtask 内解决）
- 运行时依赖：Pillow 未安装时无法生成缩略图（对外表现为 `503 PILLOW_NOT_INSTALLED`）；本次自测环境未覆盖“成功生成 200 + 304”分支
- 缓存治理：未实现缓存清理/TTL（key 更新会产生陈旧文件残留，磁盘占用可增长）
- 格式支持：`.heic/.avif/.svg` 等扩展名虽被归类为 image，但 Pillow 在无解码支持时会失败并返回 `THUMBNAIL_FAILED`
- 批量预热：`/api/thumbs/warm` 仅入队，无进度/完成度查询接口；队列满时会拒绝部分请求（计入 `rejected`）
