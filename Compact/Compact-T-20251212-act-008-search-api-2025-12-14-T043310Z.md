# Compact — T-20251212-act-008-search-api

## Scope
- Subtask: `T-20251212-act-008-search-api`（实现基于索引的全局搜索 API）
- Type: build, Priority: P1, Lane: next
- Dependency: `T-20251212-act-001-classify-api`（已完成）
- Acceptance (record.json):
  - 按关键字返回匹配的相册/文件结果
  - 结果包含类型与定位信息（相册名/相对路径）
  - 万级条目下响应时间记录在测试备注
- Change set (code):
  - 新增 `backend/indexing/search.py`：基于 `MediaIndex` 的搜索（大小写不敏感、token AND、可限量）
  - 扩展 `backend/indexing/media_index.py`：新增 `MediaIndex.images`（全量图片文件，含 `album_rel_path`）
  - 更新 `backend/api/server.py`：新增 `GET /api/search`
  - 新增/更新自测：`backend/api/tests/test_server.py`、`backend/indexing/tests/test_search.py`
- Self-test: `python3 -m unittest discover -v` → OK（28 tests）

## Confirmed Facts（代码 + 自测覆盖）
- 搜索结果形状（`backend/api/server.py` + 自测覆盖 `backend/api/tests/test_server.py`）：
  - `GET /api/search?q=...` 返回 `{ media_root, scanned_at_ms, query, limit, types[], count, took_ms, items[] }`
  - `items[].kind` 取值：`album|image|video|game|other`
- 搜索行为（`backend/indexing/search.py` + 自测覆盖 `backend/indexing/tests/test_search.py`）：
  - 大小写不敏感；空白折叠；支持多 token AND（例如 `video sample`）
  - 默认 `limit=50`（可调，范围 1..200）；支持 `types=...` 过滤（逗号分隔）
- 图片可定位信息（`backend/indexing/media_index.py` + 自测覆盖 `backend/indexing/tests/test_search.py`）：
  - `MediaIndex.images` 包含所有图片文件；相册内图片带 `album_rel_path=<album_rel_path>`；散图为 `null`

## Interface / Behavior Changes（影响下游对接）
- 新增：`GET /api/search?q=<keyword>[&limit=50][&types=album,image,video,game,other][&refresh=1]`
- `took_ms` 为服务端纯搜索耗时（不含 index build / JSON dump / 网络往返）。

## Performance Notes（万级条目）
- 方法：构造 10,000 个视频文件；先请求 `/api/videos` 预热索引；再请求 `/api/search?q=video_09999&types=video&limit=20`（仅末尾命中，近似全扫描）。
- 结果（5 次）：
  - server `took_ms`: `[2,1,1,1,1]`，avg=1.2ms
  - client e2e: `[3.04,2.47,2.10,2.23,2.04]`ms，avg≈2.37ms

## Explicit Limits / TODO（显式边界）
- 当前为 substring match（非编辑距离/拼音等更高级 fuzzy）。
- 默认返回顺序：albums → videos → images → games → others；未做相关性评分/分页。
- `MediaIndex.images` 会增加常驻内存占用；若库规模进一步扩大，可考虑持久化索引、倒排索引或分页策略。

